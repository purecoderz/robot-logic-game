<!DOCTYPE html>
<html>
<head>
    <title>Go Learning Environment</title>
    <script src="wasm_exec.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; gap: 20px; }
        #editor { width: 400px; height: 400px; font-family: monospace; }
        #world { width: 400px; height: 400px; background: #eee; position: relative; border: 2px solid #333; }
        #gopher { 
            width: 40px; height: 40px; background: cyan; 
            position: absolute; left: 0; bottom: 0; 
            transition: all 0.5s ease; /* Smooth animation */
            border-radius: 50%;
        }
    </style>
</head>
<body>

    <div>
        <h3>Student Code</h3>
        <textarea id="editor">package main

func main() {
	Move()
	Move()
	TurnLeft()
	Move()
}
</textarea>
        <br><br>
        <button onclick="runSimulation()">RUN CODE</button>
        <div id="output" style="color: red; margin-top: 10px;"></div>
    </div>

    <div id="world">
        <div id="gopher"></div>
    </div>

   <script>
    // --- 1. Load the Wasm ---
    const go = new Go();
    WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject).then((result) => {
        go.run(result.instance);
    });

    // --- 2. The Visual Logic ---
    let gopherX = 0;
    let gopherY = 0;
    let animationQueue = [];
    let isAnimating = false;

    // --- FIX IS HERE: We explicitly define the function Go is looking for ---
    
    // Make sure this is attached to 'window' so Go can see it
    window.moveRobot = function() {
        // If you are using the simple version, this runs immediately
        console.log("Go called moveRobot!");
        addToAnimationQueue("move");
    };

    window.turnRobot = function(dir) {
        addToAnimationQueue("turnLeft");
    };

    // Also support the queue method directly if you update Go later
    window.addToAnimationQueue = (action) => {
        animationQueue.push(action);
        processQueue(); // Try to run it immediately
    };

    // --- 3. The Animation Handler ---
    async function processQueue() {
        if (isAnimating || animationQueue.length === 0) return;
        isAnimating = true;

        const action = animationQueue.shift();
        const el = document.getElementById("gopher"); // Ensure your div ID is 'gopher'

        if (action === "move") {
            gopherX += 40; 
            if(el) el.style.left = gopherX + "px";
        } else if (action === "turnLeft") {
            if(el) el.style.filter = "hue-rotate(90deg)";
        }

        // Wait 500ms for animation
        await new Promise(r => setTimeout(r, 600));
        
        isAnimating = false;
        processQueue(); // Check for next move
    }

    // --- 4. The Run Button ---
    window.runSimulation = function() {
        // Reset
        animationQueue = [];
        gopherX = 0;
        const el = document.getElementById("gopher");
        if(el) {
            el.style.left = "0px";
            el.style.filter = "none";
        }
        
        let code = document.getElementById("editor").value;
        
        // Call Go
        let result = window.runGoCode(code);
        
        // Update Output
        const outputEl = document.getElementById("output");
        if(outputEl) outputEl.innerText = result;
    }
</script>
</body>
</html>